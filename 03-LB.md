# Scalability and High Availability

* Scalability means that and application / system can handle greater loads by adapting
  * 2 types of scalability:
    * vertical scalability == increase the size of the instance
      * very common for non-distributed systems like DBs: RDS / ElastiCache => scale vertically
      * hardware limit to how much you can vertically scale
    * horizontal scalability (elasticity) == adding more instances
      * implies distributed systems
      * very common for web/modern apps
      * easy to scale having EC2

* High Availability
  * usally goes hand in hand with horizontal scaling
  * High Availability means running your app/system in at least 2 data centers == AZ
  * goal: survie a data center loss
  * HA can be *passive* == RDS Multi AZ.
  * HA can be *active* == for horizontal scaling

* Vertical Scaling: icnrease isntance size (scale up / down)

* Horizontal Scaling: increase number of instances (scale in / out)
* auto scaling group
* load balancer

* High Availability: run instances for the same app across different AZs
* ASG multi AZ
* LB multi AZ

## Load Balacing

* LBs are servers that forward internet traffic to multiple servers (EC2 instances) downstream

* Why use an LB
  * Used to spread load across multiple downstream instances
  * Expose a single point of access (DNS) to your app.
  * Seamleassly handle failures of downstream instances (because of healthchecks)
  * Do regular health checks to your instances
  * Provide SSL termination (HTTPS) for your websites
  * Enforce stickiness with cookies
  * High availability across zones
  * Separate public traffic from private

* AWS ELB
* managed by AWS
* AWS guarantees it will be working
* AWS takes care of upgrades, maintenance, high availability
* AWS provides a few configurations knos
* Integrated with many AWS offerings / services
* EC2 / ASG / ECS
* ACM / CloudWatch
* R53 / AWS WAF / AWS Global Accelerator

## Health Checks

* They enable the load balancer to know if instances it forwards traffic to are available to reply to requests
* The health check is done on a port and route (/health is common)
* If the response is not 200 (OK), then the instance is unhealthy and traffic will not be forwarded

## Types of LBs

* Classic LB (old gen)
  * Deprecated
  * v1 - older generation - 2009
  * CLB - Classic Load Balancer
  * Supports: HTTP / HTTPS / TCP / SSL

* Application LB (new gen)
  * v2 - new generation
  * ALB (Application Load Balancer)
  * HTTP / HTTPS / WebSocket
  * Work at Layer 7
  * Load balancing to multiple HTTP apps across machines (target groups)
  * Load balancing to multiple applications on the same machine (containers using ECS)
  * Routing tables to different target groups:
  * Routing based on path in URL (example.com/users & example.com/posts)
  * Routing based on hostname in URL (one.example.com & other.example.com)
  * Routing based on query String, Headers (example.com/users?id=123&order=false)
  * great for microservices & container apps
  * Has a port mapping feature to redirect to a dynamic port in ECS
  * In comparison, we would need to create one Classic Load Balancer per app. Expensive and inefficent
* ALB Target Groups
  * EC2 Instances (can be managd by an ASG) - HTTP
  * ECS Tasks (managed by ECS itself) - HTTP
  * Lambda Functions - HTTP request is translated into a JSON event
  * IP addresses - must be *private ips*

* Good to know
  * fixed hostname: (XXX.region.elb.amazonaws.com)
  * App servers don't see the IP of the client directly
  * the true IP of the client is inserted in the header *X-Forwarded-For*
  * Can also get Port (*X-Forwarded-Port*) and proto (*X-Forwared-Proto*)
  * Stickiness can be enabled at the target group level
    * same request goes to the same instance
  * stickiness is directly generated by the ALB (not the app)
  * Supports HTTP/HTTPS & Websockets protocols
  * Cannot balance load based on geography

* Network LB (new gen)
  * v2 - new generation
  * NLB (Network Load Balancer)
  * TCP / TLS / UDP
  * Work at Layer 4
  * Forward TCP traffic to your instances
  * Handles millions of requests per seconds
  * NLB has *one static ip per AZ* and supports assigning ElasticIP
  * Support for static IP or elastic IP
  * Less latency ~100 ms (vs 400ms for ALB)
  * Mostly used for extreme performance - not the default choice
  * Can directly see the client IP
  * *NO AWS FREE TIER*
  * Healths checks performed by NLB: TCP / HTTP / HTTPS
* NLB Target Groups
  * EC2 Instances
  * IP addresses - must be private IPs
  * ALB - get fixed ip address and ALB routes paths

* Gateway LB
  * operates at layer 3 (network layer)
  * IP protocol
  * 2 functions:
    * transparent network gateway: single entry/exit for all traffic
    * load balancer: distributes traffic to you virtual appliances
  * usess the *GENEVE* protocol on *port 6081*
  * Used to: Deploy, scale and manage a fleet of 3rd party network virtual appliances in AWS
  * Example: firewalls / intrusion detecion and prevention systems / deep packet inspection systems / payload
      manipulation => all at the netork leve
  * ex: you want all traffic to go through inspection before arriving the instance.
  * User goes to GWLB -> ec2 instance with inspection sw -> back to GWLB -> ec2 instance with app
  * also can drop traffic => firewall rejecting not wanted traffic
* GWLB Target groups
  * EC2 instances
  * IP addreses - must be privates IPs

## SG for LB

* LB SG
  * Users: allowed port 80 / 443 | source = anywhere | to load balancer
* App SG
  * App: allow traffic only from LB
  * source: an SG - linked LB to App

## LB Stickiness (session affinity)

* Same client is always redirected to the same instance behind a load balancer
* Works for CLB and ALB
* The "cookie" used for stickiness has an expiration date you control
* Use case: make sure user doesn't lose session data
* may bring imbalance to the load over backend EC2 instances

* Sticky sessions - Cookie names
  * Application-based cookies
    * custom cookie - generated by the target
    * cookie name must be specified individually for each target group
    * *DONT* user AWSALB AWSALAPP or AWSALBTG (reserved for the LB)
  * Application cookie
    * generated by the load balancer
    * cookie name is *AWSALBAPP*
  * Duration-based cookies
    * generated by the LB
    * cookie name is AWSALB for ALB and AWSELB for CLB
    * expiry based on specific duration - duration specified by LB

## ELB - Cross Zone Load Balancing

* each load balancer instance distributes evenly across all registered instances in all AZ
  * ex: 1 AZ with 2 instances / 1 AZ with 8 instances => cross zone load balancing distributes evenly between all 10 EC2 instances
* *WITHOUT* Cross Zone load balancing:
  * requests are distributed in the instances of the node of the elastic load balancer
  * ex: 1 AZ with 2 instances / 1 AZ with 8 instances => AZ1 will split 50/50 for the 2 instances - AZ2 will split among the 8 instances
* *For ALB* enabled by default (can be disabled at the Target Group level)
  * *no charges* for inter AZ data
* *For NLB && GWLB* disabled by default
  * *extra charges* when enabled
* *For CLB* enabled by default
  * *no charges* for inter AZ data

## ELB - SSL/TLS basics

* SSL certificate allows traffic between your clients and your load balancer to be encrypted in transit (in-flight encryption)
* SSL == Secure Sockets Layer => used to encrypt connections
* TlS == Transport Layer Security => newer version
